# TÃªn cá»§a quy trÃ¬nh CI (Continuous Integration)
name: .NET CI Build and Test

# KÃ­ch hoáº¡t workflow nÃ y khi cÃ³ push hoáº·c pull request vÃ o nhÃ¡nh 'main'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    # Cháº¡y trÃªn mÃ¡y áº£o Ubuntu má»›i nháº¥t (do GitHub cung cáº¥p)
    runs-on: ubuntu-latest

    # â­ï¸ GIáº¢I QUYáº¾T Lá»–I MSB1003 Táº I ÄÃ‚Y â­ï¸
    # ChÃºng ta Ä‘áº·t thÆ° má»¥c lÃ m viá»‡c máº·c Ä‘á»‹nh cho Táº¤T Cáº¢ cÃ¡c lá»‡nh "run:"
    # Báº¡n PHáº¢I thay Ä‘á»•i 'TenThuMucChuaFileSLN' thÃ nh tÃªn thÆ° má»¥c thá»±c táº¿ cá»§a báº¡n
    # VÃ­ dá»¥: náº¿u file cá»§a báº¡n á»Ÿ 'MyProject/MyProject.sln', báº¡n Ä‘iá»n: ./MyProject
    defaults:
      run:
        working-directory: ./DemoGitHubWeb

    steps:
    # BÆ°á»›c 1: Checkout
    - name: Checkout repository
      uses: actions/checkout@v4

    # BÆ°á»›c 2: Setup .NET
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # BÆ°á»›c 3: Restore
    - name: Restore dependencies
      run: dotnet restore

    # BÆ°á»›c 4: Publish
    - name: Build and Publish Project
      run: dotnet publish -c Release -o ./publish_output

    # BÆ°á»›c 5: Test
    - name: Run tests
      run: |
        echo "Starting tests triggered by user: ${{ github.actor }}"
        echo "Condition for step Upload Build Artifact: ${{ github.ref }} -  ${{ github.event_name }}"
        dotnet test --no-build

    # BÆ°á»›c 6: Upload Artifact (Vá»›i logic IF)
    # â­ï¸ DEMO 3: BÆ¯á»šC CÃ“ ÄIá»€U KIá»†N (IF)
    # ChÃºng ta thÃªm Ä‘iá»u kiá»‡n "if:". BÆ°á»›c nÃ y sáº½ CHá»ˆ CHáº Y Náº¾U
    # 1. Workflow nÃ y Ä‘Æ°á»£c kÃ­ch hoáº¡t bá»Ÿi má»™t 'push' (khÃ´ng pháº£i Pull Request)
    # 2. VÃ€ nhÃ¡nh Ä‘Ã³ lÃ  'main' (ref == 'refs/heads/main')
    - name: Upload Build Artifact
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        # TÃªn file zip sáº½ bao gá»“m: TÃªn HÄH (tá»« matrix) VÃ€ TÃªn ngÆ°á»i thao tÃ¡c
        name: web-app-${{ matrix.os }}-${{ github.actor }}

        # â­ï¸ Sá»¬A Lá»–I ÄÆ¯á»œNG DáºªN:
        # Chá»‰ Ä‘Æ°á»ng dáº«n Ä‘áº§y Ä‘á»§ (tá»« gá»‘c repo) Ä‘áº¿n thÆ° má»¥c mÃ  'dotnet publish' Ä‘Ã£ táº¡o ra
        # (Giáº£ sá»­ working-directory cá»§a báº¡n lÃ  ./DemoGitHubWeb)
        path: ./DemoGitHubWeb/publish_output

    # BÆ°á»›c 7: ThÃ´ng bÃ¡o khi tháº¥t báº¡i (Error Handling)
    # â­ï¸ DEMO 4: CHáº Y KHI THáº¤T Báº I
    # BÆ°á»›c nÃ y cÃ³ "if: failure()"
    # NÃ³ sáº½ luÃ´n bá»‹ bá» qua (skip) náº¿u má»i thá»© thÃ nh cÃ´ng.
    # NÃ³ sáº½ CHá»ˆ CHáº Y Náº¾U báº¥t ká»³ bÆ°á»›c nÃ o á»Ÿ trÃªn (nhÆ° Build hoáº·c Test) bÃ¡o lá»—i (mÃ u Ä‘á»).
    - name: Notify on Failure
      if: failure()
      run: |
        echo "ğŸ”´ BUILD HOáº¶C TEST ÄÃƒ THáº¤T Báº I!"
        echo "HÃ£y kiá»ƒm tra log á»Ÿ cÃ¡c bÆ°á»›c trÃªn Ä‘á»ƒ xem chi tiáº¿t lá»—i."
        echo "ÄÃ¢y lÃ  nÆ¡i báº¡n cÃ³ thá»ƒ thÃªm lá»‡nh Ä‘á»ƒ gá»­i thÃ´ng bÃ¡o tá»›i Slack, Discord hoáº·c Teams."
